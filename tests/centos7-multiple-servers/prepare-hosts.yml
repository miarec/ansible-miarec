# - name: Gather facts of all hosts
#  hosts: all
#  gather_facts: True
#  tasks:
#    - debug: var=ansible_distribution

# ------------------------------------------------
# Disable SELinux on all hosts
# ------------------------------------------------
- name: Disable SELinux
  hosts: all
  roles:
    - role: 'disable-selinux'
      tags: 'disable-selinux'


# ------------------------------------------------
# Install database
# ------------------------------------------------
- name: Install PostgreSQL
  hosts: db
  vars_files:
    - ../../vars/postgresql.yml

  become: yes
  roles:
    - role: 'postgresql'
      tags: 'postgresql'

      # Listen on all interfaces. By default, it listens on localhost only
      postgresql_listen_addresses: "*"

      # -------------------------------------------------
      # Define the trusted hosts in pg_hba.conf file
      # Here we allow inbound connections from recorder and web servers
      # -------------------------------------------------
      postgresql_pg_hba_custom:
        - comment: 'IPv4 local connections:'
          address: '127.0.0.1/32'
          type: host
          database: all
          user: "{{ miarec_db_user }}"
          method: 'md5'

        - comment: 'IPv6 local connections:'
          address: '::1/128'
          type: host
          database: all
          user: "{{ miarec_db_user }}"
          method: 'md5'

        - comment: "IPv4 connection from rec1:"
          address: "{{ rec1_ip_address }}/32" 
          user: "{{ miarec_db_user }}"
          type: host
          database: all
          method: 'md5'

        - comment: "IPv4 connection from rec2:"
          address: "{{ rec2_ip_address }}/32" 
          user: "{{ miarec_db_user }}"
          type: host
          database: all
          method: 'md5'

        - comment: "IPv4 connection from web1:"
          address: "{{ web1_ip_address }}/32" 
          user: "{{ miarec_db_user }}"
          type: host
          database: all
          method: 'md5'

        - comment: "IPv4 connection from web2:"
          address: "{{ web2_ip_address }}/32" 
          user: "{{ miarec_db_user }}"
          type: host
          database: all
          method: 'md5'


# ------------------------------------------------
# Install redis
# ------------------------------------------------
- name: Install redis
  hosts: redis
  vars_files:
    - ../../vars/redis.yml
  become: yes
  roles:
    - role: 'redis'
      tags: 'redis'
      # Networking/connection options (bind to all interfaces)
      redis_bind: 0.0.0.0 


# ------------------------------------------------
# Install Apache
# ------------------------------------------------
- name: Install Apache
  hosts: web
  vars_files:
    - ../../vars/apache.yml
  become: yes
  roles:
    - role: 'apache'
      tags: 'apache'


# ------------------------------------------------
# Install Python (web, celery, celerybeat)
# ------------------------------------------------
- name: Install Python
  hosts: 
    - web
    - celery
    - celerybeat
  vars_files:
    - ../../vars/python.yml
  become: yes
  roles:
    - role: 'python'
      tags: 'python'

