---
# The variables file used by the playbooks in the db group.

# Listen on all interfaces. By default, it listens on localhost only
postgresql_listen_addresses: "*"

# -------------------------------------------------
# Firewall configuration for Database server
# Here we allow inbound connections from recorder and web servers
# -------------------------------------------------
iptables_keep_unmanaged: yes
iptables_custom_rules:
  - name: open_postgresql_port_rec1
    rules: "-A INPUT -p tcp --dport 5432 -s {{ hostvars['rec1.miarec'].ansible_eth1.ipv4.address }} -j ACCEPT"
    state: present
  - name: open_postgresql_port_rec2
    rules: "-A INPUT -p tcp --dport 5432 -s {{ hostvars['rec2.miarec'].ansible_eth1.ipv4.address }} -j ACCEPT"
    state: present
  - name: open_postgresql_port_web
    rules: "-A INPUT -p tcp --dport 5432 -s {{ hostvars['web.miarec'].ansible_eth1.ipv4.address }} -j ACCEPT"
    state: present

# -------------------------------------------------
# Define the trusted hosts in pg_hba.conf file as well
# Here we allow inbound connections from recorder and web servers
# -------------------------------------------------
postgresql_pg_hba_custom:
  - comment: 'IPv4 local connections:'
    address: '127.0.0.1/32'
    type: host
    database: all
    user: "{{ miarec_db_user }}"
    method: 'md5'

  - comment: 'IPv6 local connections:'
    address: '::1/128'
    type: host
    database: all
    user: "{{ miarec_db_user }}"
    method: 'md5'

  - comment: "IPv4 connection from rec1:"
    address: "{{ hostvars['rec1.miarec'].ansible_eth1.ipv4.address }}/32" 
    user: "{{ miarec_db_user }}"
    type: host
    database: all
    method: 'md5'

  - comment: "IPv4 connection from rec2:"
    address: "{{ hostvars['rec2.miarec'].ansible_eth1.ipv4.address }}/32" 
    user: "{{ miarec_db_user }}"
    type: host
    database: all
    method: 'md5'

  - comment: "IPv4 connection from web:"
    address: "{{ hostvars['web.miarec'].ansible_eth1.ipv4.address }}/32" 
    user: "{{ miarec_db_user }}"
    type: host
    database: all
    method: 'md5'
