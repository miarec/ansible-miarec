# ------------------------------------------------
# Create SelfSigned Certificate for intra cluster traffic
# ------------------------------------------------
- name: Generate Private TLS infrastructure
  hosts:
    - all

  pre_tasks:
    - name: Define CA Root server and variables
      set_fact:
        openssl_root: "{{ groups.db.0 }}"

        openssl_ca_common_name: miarec-CA
        openssl_ca_key: "{{ openssl_ca_common_name }}.key"
        openssl_base_dir: /etc/openssl
        openssl_ca_dir: "{{ openssl_base_dir }}/ca"
        openssl_servers_dir: "{{ openssl_base_dir }}/servers"


    - set_fact:
        tmp_servers:
          common_name: "{{ hostvars[item].inventory_hostname }}"
          alt_dns: ["{{ hostvars[item].private_ip_address }}"]
          # country: US
          # org: miarec
      with_items: "{{ groups.db + groups.recorder }}"
      register: _tmp_openssl_servers

    - set_fact:
        openssl_servers: "{{ _tmp_openssl_servers.results | selectattr('ansible_facts', 'defined') | map(attribute='ansible_facts.tmp_servers') | list  }}"

  post_tasks:

    - name: Fetch CA server certs from root
      command:
        cmd:  cat {{ openssl_ca_dir }}/{{ openssl_ca_common_name }}.key
      register: _ca_cert
      when: inventory_hostname in openssl_root
      become: true
      changed_when: false

    - name: Fetch for server certs for db
      command:
        cmd:  cat {{ openssl_servers_dir }}/{{ hostvars[item].inventory_hostname }}/{{ hostvars[item].inventory_hostname }}.crt   # This needs to be a variale
      register: _db_cert
      when: inventory_hostname in openssl_root
      become: true
      with_items: "{{ groups.db }}"
      changed_when: false

    - name: Fetch for server key for db
      command:
        cmd:  cat {{ openssl_servers_dir }}/{{ hostvars[item].inventory_hostname }}/{{ hostvars[item].inventory_hostname }}.key   # This needs to be a variale
      register: _db_key
      when: inventory_hostname in openssl_root
      become: true
      with_items: "{{ groups.db }}"
      changed_when: false


    # - set_fact:
    #     tmp_clients:
    #       common_name: "{{ hostvars[item].inventory_hostname }}"
    #   with_items: "{{ groups.web }}"
    #   register: _tmp_openssl_clients

    # - set_fact:
    #     openssl_clients: "{{ _tmp_openssl_clients.results | selectattr('ansible_facts', 'defined') | map(attribute='ansible_facts.tmp_clients') | list  }}"

  roles:
    - role: 'private-tls'

# ------------------------------------------------
# Place Server certs on DB for Redis
# ------------------------------------------------
- name: Put Server Certs on DB for redis
  hosts:
    - db

  become: true
  vars_files:
    - vars/redis.yml

  # pre_tasks:

  #   - debug:
  #       var: _db_cert_key

  tasks:
    - name: Create pki directory
      file:
        dest: "{{ redis_tls_dir }}"
        state: directory


    - name: Place CA Cert on DB
      copy:
        content: "{{ _ca_cert.stdout }}"
        dest: "{{ redis_tls_ca_cert }}"

    - name: Place Server Cert on DB
      copy:
        content: "{{ _db_cert.results.0.stdout }}"
        dest: "{{ redis_tls_cert }}"

    - name: Place Server Key on DB
      copy:
        content: "{{ _db_key.results.0.stdout }}"
        dest: "{{ redis_tls_key }}"

