# ------------------------------------------------
# Create SelfSigned Certificate for intra cluster traffic
# ------------------------------------------------
- name: Generate Private TLS config
  hosts:
    - all

  pre_tasks:

    - set_fact:
        openssl_root: "{{ groups.db.0 }}"

    - set_fact:
        tmp_servers:
          common_name: "{{ hostvars[item].inventory_hostname }}"
          alt_dns: ["{{ hostvars[item].private_ip_address }}"]
          # country: US
          # org: miarec
      with_items: "{{ groups.db + groups.recorder }}"
      register: _tmp_openssl_servers

    - set_fact:
        openssl_servers: "{{ _tmp_openssl_servers.results | selectattr('ansible_facts', 'defined') | map(attribute='ansible_facts.tmp_servers') | list  }}"

    # - set_fact:
    #     tmp_clients:
    #       common_name: "{{ hostvars[item].inventory_hostname }}"
    #   with_items: "{{ groups.web }}"
    #   register: _tmp_openssl_clients

    # - set_fact:
    #     openssl_clients: "{{ _tmp_openssl_clients.results | selectattr('ansible_facts', 'defined') | map(attribute='ansible_facts.tmp_clients') | list  }}"



  roles:
    - role: 'private-tls'
